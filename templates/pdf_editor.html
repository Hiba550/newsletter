<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Editor</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-document: #dfe6ed;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --toolbar-bg: #ffffff;
            --input-bg: #ffffff;
            --button-hover: #f1f5f9;
            --accent: #2563eb;
            --accent-light: #eff6ff;
            --accent-dark: #1d4ed8;
            --success: #059669;
            --warning: #f59e0b;
            --error: #dc2626;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --bg-tertiary: #334155;
            --bg-document: #0c1322;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --border-color: #334155;
            --border-hover: #475569;
            --toolbar-bg: #1e293b;
            --input-bg: #334155;
            --button-hover: #475569;
            --accent: #3b82f6;
            --accent-light: #1e3a5f;
            --accent-dark: #2563eb;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.2s ease, color 0.2s ease;
            -webkit-font-smoothing: antialiased;
        }
        
        .editor {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* Top bar */
        .top-bar {
            background: var(--toolbar-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .top-bar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .top-bar h6 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .top-bar .subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        .top-actions {
            display: flex;
            gap: 0.6rem;
            align-items: center;
        }
        
        /* Toolbar */
        .toolbar {
            background: var(--toolbar-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.6rem 1.25rem;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .toolbar::-webkit-scrollbar {
            height: 6px;
        }
        
        .toolbar::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        
        .toolbar::-webkit-scrollbar-thumb {
            background: var(--border-hover);
            border-radius: 3px;
        }
        
        .toolbar::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        .toolbar-row {
            display: flex;
            gap: 0.6rem;
            align-items: center;
            min-width: max-content;
        }
        
        .tool-group {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            padding: 4px 5px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }
        
        .tool-btn {
            background: var(--input-bg);
            border: 1px solid transparent;
            color: var(--text-primary);
            padding: 0.45rem 0.55rem;
            min-width: 34px;
            height: 34px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }
        
        .tool-btn:active {
            transform: translateY(0) scale(0.96);
        }
        
        .tool-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }
        
        .tool-select {
            border: 1px solid var(--border-color);
            padding: 0.4rem 0.6rem;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.15s ease;
            height: 34px;
        }
        
        .tool-select:hover {
            border-color: var(--border-hover);
        }
        
        .tool-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .tool-divider {
            width: 1px;
            height: 26px;
            background: var(--border-color);
            margin: 0 4px;
        }
        
        /* Workspace */
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 270px;
            background: var(--toolbar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-hover);
            border-radius: 3px;
        }
        
        .sidebar-section {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1rem;
            border: 1px solid var(--border-color);
        }
        
        .sidebar-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .sidebar-title i {
            font-size: 0.75rem;
            color: var(--accent);
        }
        
        .sidebar-btn {
            width: 100%;
            padding: 0.6rem 0.875rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            text-align: left;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
        }
        
        .sidebar-btn i {
            width: 16px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .sidebar-btn:last-child {
            margin-bottom: 0;
        }
        
        /* Document area */
        .doc-area {
            flex: 1;
            overflow: auto;
            background: var(--bg-document);
            padding: 2rem;
            background-image: 
                radial-gradient(circle at 1px 1px, var(--border-color) 1px, transparent 0);
            background-size: 20px 20px;
        }
        
        .doc-area::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .doc-area::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        .doc-area::-webkit-scrollbar-thumb {
            background: var(--border-hover);
            border-radius: 5px;
            border: 2px solid var(--bg-tertiary);
        }
        
        .doc-area::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        .page {
            background: var(--bg-primary);
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
            position: relative;
            border-radius: 4px;
            overflow: visible;
        }
        
        #doc {
            padding: 0;
            min-height: 297mm;
            outline: none;
            position: relative;
            overflow: visible;
        }
        
        #doc:focus {
            outline: none;
        }
        
        #doc * {
            max-width: 100% !important;
        }
        
        #doc img {
            max-width: 100% !important;
            height: auto !important;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 4px;
        }
        
        #doc img:hover {
            outline: 3px solid var(--accent-light);
            outline-offset: 2px;
        }
        
        #doc img.selected {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Image controls */
        .img-controls {
            position: fixed;
            background: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 1000;
            min-width: 200px;
        }
        
        .img-controls.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .img-control-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-tertiary);
            margin-bottom: 0.6rem;
        }
        
        .img-control-group {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.6rem;
            align-items: center;
        }
        
        .img-control-group:last-child {
            margin-bottom: 0;
        }
        
        .img-control-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 40px;
        }
        
        .img-input {
            width: 65px;
            padding: 0.35rem 0.4rem;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.15s ease;
        }
        
        .img-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Status bar */
        .status-bar {
            background: var(--toolbar-bg);
            border-top: 1px solid var(--border-color);
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .status-info {
            display: flex;
            gap: 1.25rem;
            align-items: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }
        
        .status-item i {
            font-size: 0.7rem;
            color: var(--accent);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }
        
        .zoom {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }
        
        .zoom-btn {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 28px;
            height: 28px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        #zoomTxt {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            font-family: 'Inter', monospace;
            font-size: 0.8rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.55rem 1.1rem;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-dark) 0%, #1e3a8a 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-outline {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-outline:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-hover);
        }
        
        .btn-icon {
            padding: 0.45rem;
            min-width: 32px;
        }
        
        /* Image resize handles */
        img.selected {
            outline: 2px solid var(--accent);
            position: relative;
        }
        
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--bg-primary);
            border: 2px solid var(--accent);
            z-index: 1000;
            border-radius: 1px;
        }
        
        .resize-handle.nw { cursor: nw-resize; top: -4px; left: -4px; }
        .resize-handle.n { cursor: n-resize; top: -4px; left: 50%; transform: translateX(-50%); }
        .resize-handle.ne { cursor: ne-resize; top: -4px; right: -4px; }
        .resize-handle.e { cursor: e-resize; top: 50%; right: -4px; transform: translateY(-50%); }
        .resize-handle.se { cursor: se-resize; bottom: -4px; right: -4px; }
        .resize-handle.s { cursor: s-resize; bottom: -4px; left: 50%; transform: translateX(-50%); }
        .resize-handle.sw { cursor: sw-resize; bottom: -4px; left: -4px; }
        .resize-handle.w { cursor: w-resize; top: 50%; left: -4px; transform: translateY(-50%); }
        
        /* Newsletter-style tables - matching newsletter aesthetic */
        #doc table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: visible !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }
        
        #doc .contents-table {
            overflow: visible !important;
        }
        
        #doc table tbody {
            position: relative;
        }
        
        #doc table tr {
            position: relative;
        }
        
        #doc table td, #doc table th {
            border: none;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            text-align: left;
            font-size: 10.5pt;
            position: relative;
        }
        
        #doc table th {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 9pt;
            border: none;
        }
        
        #doc table tbody tr:nth-child(odd) td {
            background: #f9fafb;
        }
        
        #doc table tbody tr:nth-child(even) td {
            background: white;
        }
        
        #doc table tbody tr:hover td {
            background: #eff6ff;
        }
        
        #doc table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Table row/column buttons */
        .table-row-add-btn, .table-row-del-btn {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease, background 0.2s ease;
            z-index: 100;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        
        .table-row-add-btn { background: #2563eb; }
        .table-row-del-btn { background: #dc2626; left: 28px; }
        
        #doc table tr:hover .table-row-add-btn,
        #doc table tr:hover .table-row-del-btn,
        .table-row-add-btn:hover,
        .table-row-del-btn:hover {
            opacity: 1;
        }
        
        .table-row-add-btn:hover { transform: translateY(-50%) scale(1.15); background: #1d4ed8; }
        .table-row-del-btn:hover { transform: translateY(-50%) scale(1.15); background: #b91c1c; }
        
        .table-col-add-btn, .table-col-del-btn {
            position: absolute;
            top: 5px;
            width: 20px;
            height: 20px;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease, background 0.2s ease;
            z-index: 100;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        
        .table-col-add-btn { background: #2563eb; right: 5px; }
        .table-col-del-btn { background: #dc2626; right: 28px; }
        
        #doc table th:hover .table-col-add-btn,
        #doc table td:hover .table-col-add-btn,
        #doc table th:hover .table-col-del-btn,
        #doc table td:hover .table-col-del-btn,
        .table-col-add-btn:hover,
        .table-col-del-btn:hover {
            opacity: 1;
        }
        
        .table-col-add-btn:hover { transform: scale(1.15); background: #1d4ed8; }
        .table-col-del-btn:hover { transform: scale(1.15); background: #b91c1c; }
        
        /* Newsletter-style horizontal rules */
        #doc hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, transparent, #e5e7eb, transparent);
            margin: 24px 0;
        }
        
        /* Newsletter-style blockquotes */
        #doc blockquote {
            border-left: 4px solid #fbbf24;
            background: linear-gradient(135deg, #fefce8 0%, #ffffff 100%);
            padding: 16px 20px;
            margin: 16px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #374151;
        }
        
        /* Newsletter-style code blocks */
        #doc pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9pt;
            overflow-x: auto;
            margin: 16px 0;
        }
        
        #doc code {
            background: #f1f5f9;
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }
        
        #doc pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }
        
        /* Modal Styles */
        .modal-content {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--toolbar-bg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            padding: 0.875rem 1rem;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            padding: 0.6rem 1rem;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
            display: block;
        }
        
        .form-control {
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 0.55rem 0.75rem;
            font-size: 0.8rem;
            transition: all 0.15s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .btn-close {
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }
        
        .btn-close:hover {
            opacity: 1;
        }
        
        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Loading State */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            color: var(--text-tertiary);
        }
        
        .loading-spinner i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }
        
        /* Find and Replace Panel */
        .find-replace-panel {
            position: fixed;
            top: 120px;
            right: 24px;
            width: 340px;
            background: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
            overflow: hidden;
        }
        
        .find-replace-panel.show {
            display: block;
            animation: slideIn 0.2s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .find-replace-header {
            padding: 0.875rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .find-replace-body {
            padding: 1rem;
        }
        
        .find-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .find-input-group input {
            flex: 1;
            padding: 0.55rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        
        .find-input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .find-actions {
            display: flex;
            gap: 0.4rem;
            justify-content: flex-end;
        }
        
        .find-btn {
            padding: 0.45rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .find-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        
        .find-count {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-bottom: 0.6rem;
        }
        
        /* Page Navigation */
        .page-nav {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            z-index: 100;
        }
        
        .page-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--toolbar-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.15s ease;
        }
        
        .page-nav-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Shortcuts help */
        .shortcuts-badge {
            display: inline-block;
            background: var(--bg-tertiary);
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-left: 6px;
            font-family: 'Inter', monospace;
        }
    </style>
</head>
<body>
    <div class="editor">
        <!-- Clean Top bar -->
        <div class="top-bar">
            <div class="top-bar-brand">
                
                <div>
                    <h6>Document Editor</h6>
                    <div class="subtitle">Edit and customize your newsletter</div>
                </div>
            </div>
            <div class="top-actions">
                <button class="btn btn-outline btn-icon" onclick="toggleFindReplace()" title="Find & Replace (Ctrl+F)">
                    <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-outline btn-icon" onclick="openSettings()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="btn btn-outline" onclick="closeEditor()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-success" id="saveBtn">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
        
        <!-- Clean Toolbar -->
        <div class="toolbar">
            <div class="toolbar-row">
                <div class="tool-group">
                    <button class="tool-btn" onclick="customUndo()" title="Undo (Ctrl+Z)">
                        <i class="fas fa-rotate-left"></i>
                    </button>
                    <button class="tool-btn" onclick="customRedo()" title="Redo (Ctrl+Y)">
                        <i class="fas fa-rotate-right"></i>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <select class="tool-select" id="font" style="width:130px;" title="Font Family">
                        <option value="Inter">Inter</option>
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Calibri">Calibri</option>
                    </select>
                    <select class="tool-select" id="size" style="width:60px;" title="Font Size">
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="14" selected>14</option>
                        <option value="16">16</option>
                        <option value="18">18</option>
                        <option value="20">20</option>
                        <option value="24">24</option>
                        <option value="28">28</option>
                        <option value="32">32</option>
                        <option value="36">36</option>
                        <option value="48">48</option>
                    </select>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="cmd('bold')" title="Bold (Ctrl+B)">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('italic')" title="Italic (Ctrl+I)">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('underline')" title="Underline (Ctrl+U)">
                        <i class="fas fa-underline"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('strikeThrough')" title="Strikethrough">
                        <i class="fas fa-strikethrough"></i>
                    </button>
                    <input type="color" id="txtColor" class="tool-btn" style="width:32px;padding:3px;cursor:pointer;" title="Text Color" value="#000000">
                    <input type="color" id="bgColor" class="tool-btn" style="width:32px;padding:3px;cursor:pointer;" title="Highlight" value="#ffff00">
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="cmd('justifyLeft')" title="Align Left">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('justifyCenter')" title="Align Center">
                        <i class="fas fa-align-center"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('justifyRight')" title="Align Right">
                        <i class="fas fa-align-right"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('justifyFull')" title="Justify">
                        <i class="fas fa-align-justify"></i>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="cmd('insertUnorderedList')" title="Bullet List">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('insertOrderedList')" title="Numbered List">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('indent')" title="Increase Indent">
                        <i class="fas fa-indent"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('outdent')" title="Decrease Indent">
                        <i class="fas fa-outdent"></i>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="addTable()" title="Insert Table">
                        <i class="fas fa-table"></i>
                    </button>
                    <button class="tool-btn" onclick="addImg()" title="Insert Image">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="tool-btn" onclick="addLink()" title="Insert Link">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('insertHorizontalRule')" title="Insert Line">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="cmd('subscript')" title="Subscript">
                        <i class="fas fa-subscript"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('superscript')" title="Superscript">
                        <i class="fas fa-superscript"></i>
                    </button>
                </div>
                
                <div class="tool-divider"></div>
                
                <div class="tool-group">
                    <button class="tool-btn" id="formatPainterBtn" onclick="toggleFormatPainter()" title="Format Painter (copy formatting)">
                        <i class="fas fa-paint-roller"></i>
                    </button>
                    <button class="tool-btn" onclick="cmd('removeFormat')" title="Clear Formatting">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Workspace -->
        <div class="workspace">
            <!-- Clean Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Insert Elements</div>
                    <button class="sidebar-btn" onclick="addTable()">
                        <i class="fas fa-table"></i> Table
                    </button>
                    <button class="sidebar-btn" onclick="addImg()">
                        <i class="fas fa-image"></i> Image
                    </button>
                    <button class="sidebar-btn" onclick="addLink()">
                        <i class="fas fa-link"></i> Hyperlink
                    </button>
                    <button class="sidebar-btn" onclick="cmd('insertHorizontalRule')">
                        <i class="fas fa-grip-lines"></i> Divider Line
                    </button>
                    <button class="sidebar-btn" onclick="insertPageBreak()">
                        <i class="fas fa-file-lines"></i> Page Break
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Text Styles</div>
                    <button class="sidebar-btn" onclick="applyStyle('h1')">
                        <i class="fas fa-heading"></i> Heading 1
                    </button>
                    <button class="sidebar-btn" onclick="applyStyle('h2')">
                        <i class="fas fa-heading"></i> Heading 2
                    </button>
                    <button class="sidebar-btn" onclick="applyStyle('h3')">
                        <i class="fas fa-heading"></i> Heading 3
                    </button>
                    <button class="sidebar-btn" onclick="applyStyle('p')">
                        <i class="fas fa-paragraph"></i> Normal Text
                    </button>
                    <button class="sidebar-btn" onclick="applyStyle('blockquote')">
                        <i class="fas fa-quote-left"></i> Quote
                    </button>
                    <button class="sidebar-btn" onclick="applyStyle('pre')">
                        <i class="fas fa-code"></i> Code Block
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Quick Actions</div>
                    <button class="sidebar-btn" onclick="cmd('selectAll')">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button class="sidebar-btn" onclick="duplicateSelection()">
                        <i class="fas fa-copy"></i> Duplicate Selection
                    </button>
                    <button class="sidebar-btn" onclick="cmd('removeFormat')">
                        <i class="fas fa-eraser"></i> Clear Format
                    </button>
                    <button class="sidebar-btn" onclick="toggleFindReplace()">
                        <i class="fas fa-search"></i> Find & Replace
                    </button>
                    <button class="sidebar-btn" onclick="printDocument()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">Keyboard Shortcuts</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); line-height: 1.8;">
                        <div><span class="shortcuts-badge">Ctrl+B</span> Bold</div>
                        <div><span class="shortcuts-badge">Ctrl+I</span> Italic</div>
                        <div><span class="shortcuts-badge">Ctrl+U</span> Underline</div>
                        <div><span class="shortcuts-badge">Ctrl+Z</span> Undo</div>
                        <div><span class="shortcuts-badge">Ctrl+Y</span> Redo</div>
                        <div><span class="shortcuts-badge">Ctrl+S</span> Export PDF</div>
                        <div><span class="shortcuts-badge">Ctrl+F</span> Find</div>
                        <div><span class="shortcuts-badge">Ctrl+H</span> Replace</div>
                        <div><span class="shortcuts-badge">Del</span> Delete selected image</div>
                        <div><span class="shortcuts-badge">Esc</span> Close panels</div>
                    </div>
                </div>
            </div>
            
            <!-- Document area -->
            <div class="doc-area">
                <div class="page">
                    <div id="doc" contenteditable="true" spellcheck="true" autocorrect="on" autocapitalize="on" role="textbox" aria-label="Document editor">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading document...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status bar -->
        <div class="status-bar">
            <div class="status-info">
                <div class="status-item">
                    <i class="fas fa-file-alt"></i>
                    <span id="pageCount">Page 1</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-font"></i>
                    <span id="words">0 words</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-text-width"></i>
                    <span id="chars">0 characters</span>
                </div>
                <div class="status-item" id="selectionInfo" style="display:none;">
                    <i class="fas fa-i-cursor"></i>
                    <span id="selWords">0 selected</span>
                </div>
            </div>
            <div class="zoom">
                <button class="zoom-btn" onclick="zoom(-10)">âˆ’</button>
                <span id="zoomTxt">100%</span>
                <button class="zoom-btn" onclick="zoom(10)">+</button>
            </div>
        </div>
    </div>
    
    <!-- Find and Replace Panel -->
    <div class="find-replace-panel" id="findReplacePanel">
        <div class="find-replace-header">
            <span>Find & Replace</span>
            <button class="btn-close" onclick="toggleFindReplace()" style="font-size: 0.7rem;"></button>
        </div>
        <div class="find-replace-body">
            <div class="find-count" id="findCount">0 matches found</div>
            <div class="find-input-group">
                <input type="text" id="findInput" placeholder="Find text..." onkeyup="handleFindKeyup(event)">
                <button class="find-btn" onclick="findPrev()" title="Previous">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <button class="find-btn" onclick="findNext()" title="Next">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="find-input-group">
                <input type="text" id="replaceInput" placeholder="Replace with...">
            </div>
            <div class="find-actions">
                <button class="find-btn" onclick="replaceOne()">Replace</button>
                <button class="find-btn" onclick="replaceAll()">Replace All</button>
            </div>
        </div>
    </div>
    
    <!-- Image controls -->
    <div class="img-controls" id="imgControls">
        <div class="img-control-title">Image Options</div>
        <div class="img-control-group">
            <span class="img-control-label">Width:</span>
            <input type="number" id="imgWidth" class="img-input" min="10" step="10">
            <span class="img-control-label">Height:</span>
            <input type="number" id="imgHeight" class="img-input" min="10" step="10">
        </div>
        <div class="img-control-group">
            <span class="img-control-label">Align:</span>
            <button class="tool-btn" onclick="alignImg('left')" title="Align Left">
                <i class="fas fa-align-left"></i>
            </button>
            <button class="tool-btn" onclick="alignImg('center')" title="Align Center">
                <i class="fas fa-align-center"></i>
            </button>
            <button class="tool-btn" onclick="alignImg('right')" title="Align Right">
                <i class="fas fa-align-right"></i>
            </button>
        </div>
        <div class="img-control-group">
            <button class="tool-btn" onclick="rotateImg(-90)" title="Rotate Left">
                <i class="fas fa-rotate-left"></i>
            </button>
            <button class="tool-btn" onclick="rotateImg(90)" title="Rotate Right">
                <i class="fas fa-rotate-right"></i>
            </button>
            <button class="tool-btn" onclick="replaceImage()" title="Replace Image">
                <i class="fas fa-arrow-right-arrow-left"></i>
            </button>
            <button class="tool-btn" onclick="deleteImg()" title="Delete" style="color: var(--error);">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
    
    <!-- Enhanced Insert Image Modal -->
    <div class="modal fade" id="insertImageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-image"></i> Insert Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Upload from Computer</label>
                        <input type="file" class="form-control" id="imageFileInput" accept="image/*">
                    </div>
                    <div class="text-center my-3" style="color: var(--text-tertiary); font-size: 0.8rem; font-weight: 600;">
                        <span style="background: var(--bg-tertiary); padding: 4px 12px; border-radius: 100px;">OR</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="text" class="form-control" id="imageUrlInput" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="insertImageFromModal()">
                        <i class="fas fa-plus"></i> Insert
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Insert Link Modal -->
    <div class="modal fade" id="insertLinkModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-link"></i> Insert Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Link Text</label>
                        <input type="text" class="form-control" id="linkTextInput" placeholder="Click here">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-control" id="linkUrlInput" placeholder="https://example.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="insertLinkFromModal()">
                        <i class="fas fa-plus"></i> Insert
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Insert Table Modal -->
    <div class="modal fade" id="insertTableModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-table"></i> Insert Table</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">Rows</label>
                            <input type="number" class="form-control" id="tableRowsInput" value="3" min="1" max="20">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Columns</label>
                            <input type="number" class="form-control" id="tableColsInput" value="3" min="1" max="10">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="insertTableFromModal()">
                        <i class="fas fa-plus"></i> Insert
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-palette"></i> Appearance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Editor Theme</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline theme-opt" onclick="changeTheme('light')" data-theme="light">
                                <i class="fas fa-sun me-2"></i> Light
                            </button>
                            <button class="btn btn-outline theme-opt" onclick="changeTheme('dark')" data-theme="dark">
                                <i class="fas fa-moon me-2"></i> Dark
                            </button>
                            <button class="btn btn-outline theme-opt" onclick="changeTheme('auto')" data-theme="auto">
                                <i class="fas fa-circle-half-stroke me-2"></i> System
                            </button>
                        </div>
                        <small style="color: var(--text-tertiary); font-size: 0.7rem; display: block; margin-top: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i>Your preference is automatically saved
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const doc = document.getElementById('doc');
        const sid = '{{ session_id }}';
        const file = '{{ html_file }}';
        let selectedImg = null;
        let zoomVal = 100;
        let savedRange = null;
        let hasUnsavedChanges = false;
        let resizing = false;
        let resizeHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let findMatches = [];
        let currentMatchIndex = -1;
        let formatPainterStyles = null;
        let formatPainterActive = false;
        
        // Custom Undo/Redo History System
        const undoStack = [];
        const redoStack = [];
        const MAX_HISTORY = 50;
        let isUndoRedo = false;
        
        function saveToHistory() {
            if (isUndoRedo) return;
            
            // Remove table buttons before saving state
            const clone = doc.cloneNode(true);
            clone.querySelectorAll('.table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn').forEach(btn => btn.remove());
            
            undoStack.push(clone.innerHTML);
            if (undoStack.length > MAX_HISTORY) {
                undoStack.shift();
            }
            redoStack.length = 0; // Clear redo stack on new action
        }
        
        function customUndo() {
            if (undoStack.length === 0) return;
            
            isUndoRedo = true;
            
            // Save current state to redo stack
            const clone = doc.cloneNode(true);
            clone.querySelectorAll('.table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn').forEach(btn => btn.remove());
            redoStack.push(clone.innerHTML);
            
            // Restore previous state
            const prevState = undoStack.pop();
            doc.innerHTML = prevState;
            
            // Re-setup handlers
            doc.querySelectorAll('img').forEach(setupImg);
            setupTableButtons();
            
            isUndoRedo = false;
            hasUnsavedChanges = true;
        }
        
        function customRedo() {
            if (redoStack.length === 0) return;
            
            isUndoRedo = true;
            
            // Save current state to undo stack
            const clone = doc.cloneNode(true);
            clone.querySelectorAll('.table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn').forEach(btn => btn.remove());
            undoStack.push(clone.innerHTML);
            
            // Restore next state
            const nextState = redoStack.pop();
            doc.innerHTML = nextState;
            
            // Re-setup handlers
            doc.querySelectorAll('img').forEach(setupImg);
            setupTableButtons();
            
            isUndoRedo = false;
            hasUnsavedChanges = true;
        }

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                savedRange = sel.getRangeAt(0);
            }
        }

        function restoreSelection() {
            const sel = window.getSelection();
            sel.removeAllRanges();
            if (savedRange) {
                sel.addRange(savedRange);
            }
        }
        
        // Track changes for auto-save warning
        let tableButtonTimeout = null;
        let historyTimeout = null;
        let lastHistorySave = 0;
        
        doc.addEventListener('input', () => {
            hasUnsavedChanges = true;
            updateStats();
            
            // Debounced history save (save after 1 second of no typing)
            clearTimeout(historyTimeout);
            const now = Date.now();
            if (now - lastHistorySave > 2000) { // Save at most every 2 seconds
                historyTimeout = setTimeout(() => {
                    saveToHistory();
                    lastHistorySave = Date.now();
                }, 1000);
            }
            
            // Debounced table button setup for new tables
            clearTimeout(tableButtonTimeout);
            tableButtonTimeout = setTimeout(() => {
                setupTableButtons();
            }, 500);
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // Paste sanitization
        doc.addEventListener('paste', (e) => {
            if (e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                document.execCommand('insertText', false, text);
            }
            setTimeout(() => {
                const elements = doc.querySelectorAll('*');
                elements.forEach(el => {
                    const keep = ['href', 'src', 'alt', 'colspan', 'rowspan'];
                    const attrs = Array.from(el.attributes);
                    attrs.forEach(attr => {
                        if (!keep.includes(attr.name) && attr.name !== 'style') {
                            el.removeAttribute(attr.name);
                        }
                    });
                });
            }, 10);
        });
        
        // Load document
        fetch(`/preview/${sid}/${file}`)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                return r.text();
            })
            .then(html => {
                try {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    
                    const styles = tmp.querySelectorAll('style');
                    if (styles.length > 0) {
                        styles.forEach(s => {
                            const style = document.createElement('style');
                            style.innerHTML = s.innerHTML;
                            document.head.appendChild(style);
                        });
                    }
                    
                    const body = tmp.querySelector('body');
                    if (body) {
                        doc.innerHTML = body.innerHTML;
                    } else {
                        doc.innerHTML = html;
                    }
                    
                    setTimeout(() => {
                        doc.querySelectorAll('img').forEach(setupImg);
                        setupTableButtons();
                        saveToHistory(); // Save initial state
                    }, 100);
                    
                    updateStats();
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    doc.innerHTML = '<div style="padding:20mm;color:red;">Error parsing content: ' + parseError.message + '</div>';
                }
            })
            .catch(err => {
                console.error('Fetch error:', err);
                doc.innerHTML = '<div style="padding:20mm;color:red;">Error loading: ' + err.message + '</div>';
            });
        
        // Update statistics
        function updateStats() {
            const text = (doc.innerText || '').trim();
            const words = text.split(/\s+/).filter(w => w).length;
            const chars = text.length;
            document.getElementById('words').textContent = words + ' words';
            document.getElementById('chars').textContent = chars + ' characters';
        }
        
        // Update selection stats
        function updateSelectionStats() {
            const sel = window.getSelection();
            const selText = sel.toString().trim();
            const selInfo = document.getElementById('selectionInfo');
            
            if (selText.length > 0) {
                const selWords = selText.split(/\s+/).filter(w => w).length;
                document.getElementById('selWords').textContent = selWords + ' selected';
                selInfo.style.display = 'flex';
            } else {
                selInfo.style.display = 'none';
            }
        }
        
        // Listen for selection changes
        document.addEventListener('selectionchange', updateSelectionStats);
        
        // Format Painter
        function toggleFormatPainter() {
            const btn = document.getElementById('formatPainterBtn');
            
            if (formatPainterActive) {
                // Deactivate
                formatPainterActive = false;
                formatPainterStyles = null;
                btn.classList.remove('active');
                doc.style.cursor = 'text';
                return;
            }
            
            // Copy styles from selected text
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && sel.toString().length > 0) {
                const range = sel.getRangeAt(0);
                let node = range.startContainer;
                if (node.nodeType === Node.TEXT_NODE) node = node.parentNode;
                
                // Capture computed styles
                const computed = window.getComputedStyle(node);
                formatPainterStyles = {
                    fontFamily: computed.fontFamily,
                    fontSize: computed.fontSize,
                    fontWeight: computed.fontWeight,
                    fontStyle: computed.fontStyle,
                    textDecoration: computed.textDecoration,
                    color: computed.color,
                    backgroundColor: computed.backgroundColor
                };
                
                formatPainterActive = true;
                btn.classList.add('active');
                doc.style.cursor = 'crosshair';
            } else {
                alert('Select text first to copy formatting');
            }
        }
        
        // Apply format painter on mouseup
        doc.addEventListener('mouseup', function() {
            if (formatPainterActive && formatPainterStyles) {
                const sel = window.getSelection();
                if (sel.rangeCount > 0 && sel.toString().length > 0) {
                    saveToHistory();
                    
                    // Create span with copied styles
                    const span = document.createElement('span');
                    span.style.fontFamily = formatPainterStyles.fontFamily;
                    span.style.fontSize = formatPainterStyles.fontSize;
                    span.style.fontWeight = formatPainterStyles.fontWeight;
                    span.style.fontStyle = formatPainterStyles.fontStyle;
                    span.style.textDecoration = formatPainterStyles.textDecoration;
                    span.style.color = formatPainterStyles.color;
                    if (formatPainterStyles.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                        span.style.backgroundColor = formatPainterStyles.backgroundColor;
                    }
                    
                    const range = sel.getRangeAt(0);
                    const text = range.toString();
                    span.textContent = text;
                    
                    range.deleteContents();
                    range.insertNode(span);
                    
                    // Deactivate format painter
                    formatPainterActive = false;
                    formatPainterStyles = null;
                    document.getElementById('formatPainterBtn').classList.remove('active');
                    doc.style.cursor = 'text';
                    hasUnsavedChanges = true;
                }
            }
        });
        
        // Commands
        function cmd(c, v = null) {
            document.execCommand(c, false, v);
            doc.focus();
        }
        
        function applyStyle(tag) {
            cmd('formatBlock', tag);
        }
        
        document.getElementById('font').onchange = function() {
            cmd('fontName', this.value);
        };
        
        document.getElementById('size').onchange = function() {
            cmd('fontSize', 7);
            doc.querySelectorAll('font[size="7"]').forEach(f => {
                f.removeAttribute('size');
                f.style.fontSize = this.value + 'pt';
            });
        };
        
        // Text color - save selection before color picker opens
        let savedColorSelection = null;
        
        document.getElementById('txtColor').addEventListener('mousedown', function() {
            savedColorSelection = saveCurrentSelection();
        });
        
        document.getElementById('txtColor').addEventListener('input', function() {
            if (savedColorSelection) {
                restoreCurrentSelection(savedColorSelection);
            }
            doc.focus();
            document.execCommand('foreColor', false, this.value);
        });
        
        document.getElementById('bgColor').addEventListener('mousedown', function() {
            savedColorSelection = saveCurrentSelection();
        });
        
        document.getElementById('bgColor').addEventListener('input', function() {
            if (savedColorSelection) {
                restoreCurrentSelection(savedColorSelection);
            }
            doc.focus();
            document.execCommand('hiliteColor', false, this.value);
        });
        
        function saveCurrentSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                return sel.getRangeAt(0).cloneRange();
            }
            return null;
        }
        
        function restoreCurrentSelection(range) {
            if (range) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        
        // Find & Replace Functions
        function toggleFindReplace() {
            const panel = document.getElementById('findReplacePanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                document.getElementById('findInput').focus();
            }
        }
        
        function handleFindKeyup(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    findPrev();
                } else {
                    findNext();
                }
            } else {
                performFind();
            }
        }
        
        function performFind() {
            clearHighlights();
            const searchText = document.getElementById('findInput').value;
            if (!searchText) {
                document.getElementById('findCount').textContent = '0 matches found';
                findMatches = [];
                currentMatchIndex = -1;
                return;
            }
            
            const walker = document.createTreeWalker(doc, NodeFilter.SHOW_TEXT, null, false);
            findMatches = [];
            let node;
            
            while (node = walker.nextNode()) {
                const text = node.textContent;
                let index = 0;
                let foundIndex;
                
                while ((foundIndex = text.toLowerCase().indexOf(searchText.toLowerCase(), index)) !== -1) {
                    findMatches.push({
                        node: node,
                        startOffset: foundIndex,
                        endOffset: foundIndex + searchText.length
                    });
                    index = foundIndex + searchText.length;
                }
            }
            
            document.getElementById('findCount').textContent = findMatches.length + ' matches found';
            
            if (findMatches.length > 0) {
                currentMatchIndex = 0;
                highlightMatch(currentMatchIndex);
            }
        }
        
        function highlightMatch(index) {
            clearHighlights();
            if (index < 0 || index >= findMatches.length) return;
            
            const match = findMatches[index];
            const range = document.createRange();
            range.setStart(match.node, match.startOffset);
            range.setEnd(match.node, match.endOffset);
            
            const span = document.createElement('span');
            span.className = 'find-highlight';
            span.style.backgroundColor = '#fbbf24';
            span.style.color = '#000';
            
            try {
                range.surroundContents(span);
                span.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                console.log('Could not highlight:', e);
            }
            
            document.getElementById('findCount').textContent = `${index + 1} of ${findMatches.length} matches`;
        }
        
        function clearHighlights() {
            doc.querySelectorAll('.find-highlight').forEach(el => {
                const parent = el.parentNode;
                while (el.firstChild) {
                    parent.insertBefore(el.firstChild, el);
                }
                parent.removeChild(el);
            });
        }
        
        function findNext() {
            if (findMatches.length === 0) {
                performFind();
                return;
            }
            currentMatchIndex = (currentMatchIndex + 1) % findMatches.length;
            highlightMatch(currentMatchIndex);
        }
        
        function findPrev() {
            if (findMatches.length === 0) {
                performFind();
                return;
            }
            currentMatchIndex = (currentMatchIndex - 1 + findMatches.length) % findMatches.length;
            highlightMatch(currentMatchIndex);
        }
        
        function replaceOne() {
            const searchText = document.getElementById('findInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!searchText || currentMatchIndex < 0) return;
            
            const highlight = doc.querySelector('.find-highlight');
            if (highlight) {
                highlight.textContent = replaceText;
                highlight.className = '';
                highlight.style.backgroundColor = '';
                highlight.style.color = '';
                
                const parent = highlight.parentNode;
                while (highlight.firstChild) {
                    parent.insertBefore(highlight.firstChild, highlight);
                }
                parent.removeChild(highlight);
            }
            
            performFind();
            hasUnsavedChanges = true;
        }
        
        function replaceAll() {
            const searchText = document.getElementById('findInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!searchText) return;
            
            clearHighlights();
            
            // Save all images before replacement
            const images = doc.querySelectorAll('img');
            const imageData = [];
            images.forEach((img, index) => {
                const placeholder = `__IMG_PLACEHOLDER_${index}__`;
                imageData.push({
                    placeholder: placeholder,
                    src: img.src,
                    style: img.getAttribute('style') || '',
                    className: img.className,
                    alt: img.alt || ''
                });
                // Create a text placeholder
                const textNode = document.createTextNode(placeholder);
                img.parentNode.replaceChild(textNode, img);
            });
            
            // Now do text replacement on the HTML (images are now placeholders)
            let html = doc.innerHTML;
            const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            html = html.replace(regex, replaceText);
            
            // Restore images from placeholders
            imageData.forEach((data) => {
                const imgTag = `<img src="${data.src}" style="${data.style}" class="${data.className}" alt="${data.alt}">`;
                html = html.replace(data.placeholder, imgTag);
            });
            
            doc.innerHTML = html;
            
            // Re-setup images for click handling
            doc.querySelectorAll('img').forEach(img => setupImg(img));
            
            // Re-setup table buttons
            setupTableButtons();
            
            document.getElementById('findCount').textContent = '0 matches found';
            findMatches = [];
            currentMatchIndex = -1;
            hasUnsavedChanges = true;
        }
        
        // Insert page break
        function insertPageBreak() {
            cmd('insertHTML', '<div class="page-break" style="page-break-after: always; height: 0; margin: 20px 0; border-top: 2px dashed #ccc;"></div>');
        }
        
        // Print document
        function printDocument() {
            window.print();
        }
        
        // Duplicate selection
        function duplicateSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && sel.toString().length > 0) {
                saveToHistory();
                const range = sel.getRangeAt(0);
                const content = range.cloneContents();
                const wrapper = document.createElement('div');
                wrapper.appendChild(content);
                
                // Move cursor to end of selection and insert duplicate
                range.collapse(false);
                const frag = document.createRange().createContextualFragment(wrapper.innerHTML);
                range.insertNode(frag);
                
                hasUnsavedChanges = true;
            }
        }
        
        // Table functions
        function addTable() {
            saveSelection();
            const modal = new bootstrap.Modal(document.getElementById('insertTableModal'));
            modal.show();
        }
        
        function insertTableFromModal() {
            const r = document.getElementById('tableRowsInput').value;
            const c = document.getElementById('tableColsInput').value;
            if (!r || !c) return;
            
            let t = '<table border="1" cellpadding="8" style="border-collapse:collapse;width:100%;margin:10px 0;"><tbody>';
            for (let i = 0; i < r; i++) {
                t += '<tr>';
                for (let j = 0; j < c; j++) {
                    t += '<td style="border:1px solid #000;padding:8px;">&nbsp;</td>';
                }
                t += '</tr>';
            }
            t += '</tbody></table><p>&nbsp;</p>';
            
            restoreSelection();
            cmd('insertHTML', t);
            
            bootstrap.Modal.getInstance(document.getElementById('insertTableModal')).hide();
            
            // Setup table buttons after inserting
            setTimeout(setupTableButtons, 100);
        }
        
        // Table row/column insertion and deletion on hover
        function setupTableButtons() {
            // Remove existing buttons first
            doc.querySelectorAll('.table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn').forEach(btn => btn.remove());
            
            const tables = doc.querySelectorAll('table');
            tables.forEach(table => {
                // Add row buttons to each row
                const rows = table.querySelectorAll('tr');
                rows.forEach((row, rowIndex) => {
                    // Create + button for adding row below
                    const addBtn = document.createElement('button');
                    addBtn.className = 'table-row-add-btn';
                    addBtn.innerHTML = '+';
                    addBtn.title = 'Add row below';
                    addBtn.contentEditable = 'false';
                    addBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        addTableRowAfter(row);
                    };
                    
                    // Create - button for deleting row (only if more than 1 row)
                    if (rows.length > 1) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'table-row-del-btn';
                        delBtn.innerHTML = 'âˆ’';
                        delBtn.title = 'Delete row';
                        delBtn.contentEditable = 'false';
                        delBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            deleteTableRow(row);
                        };
                        row.appendChild(delBtn);
                    }
                    
                    row.style.position = 'relative';
                    row.appendChild(addBtn);
                });
                
                // Add column buttons to first row cells
                const firstRow = table.querySelector('tr');
                if (firstRow) {
                    const cells = firstRow.querySelectorAll('th, td');
                    cells.forEach((cell, colIndex) => {
                        const addColBtn = document.createElement('button');
                        addColBtn.className = 'table-col-add-btn';
                        addColBtn.innerHTML = '+';
                        addColBtn.title = 'Add column after';
                        addColBtn.contentEditable = 'false';
                        addColBtn.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            addTableColAfter(table, colIndex);
                        };
                        
                        // Create - button for deleting column (only if more than 1 column)
                        if (cells.length > 1) {
                            const delColBtn = document.createElement('button');
                            delColBtn.className = 'table-col-del-btn';
                            delColBtn.innerHTML = 'âˆ’';
                            delColBtn.title = 'Delete column';
                            delColBtn.contentEditable = 'false';
                            delColBtn.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                deleteTableCol(table, colIndex);
                            };
                            cell.appendChild(delColBtn);
                        }
                        
                        cell.style.position = 'relative';
                        cell.appendChild(addColBtn);
                    });
                }
            });
        }
        
        function deleteTableRow(row) {
            saveToHistory();
            row.remove();
            setupTableButtons();
            hasUnsavedChanges = true;
        }
        
        function deleteTableCol(table, colIndex) {
            saveToHistory();
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                if (cells[colIndex]) {
                    cells[colIndex].remove();
                }
            });
            setupTableButtons();
            hasUnsavedChanges = true;
        }
        
        function addTableRowAfter(row) {
            saveToHistory(); // Save state before change
            
            const table = row.closest('table');
            const cells = row.querySelectorAll('th, td');
            const numCols = cells.length;
            const isHeader = cells[0] && cells[0].tagName === 'TH';
            
            const newRow = document.createElement('tr');
            for (let i = 0; i < numCols; i++) {
                const cell = document.createElement('td');
                cell.style.cssText = 'border-bottom:1px solid #e5e7eb;padding:12px 16px;';
                cell.innerHTML = '&nbsp;';
                newRow.appendChild(cell);
            }
            
            // Insert after the clicked row
            if (row.nextSibling) {
                row.parentNode.insertBefore(newRow, row.nextSibling);
            } else {
                row.parentNode.appendChild(newRow);
            }
            
            // Re-setup buttons
            setupTableButtons();
            hasUnsavedChanges = true;
        }
        
        function addTableColAfter(table, colIndex) {
            saveToHistory(); // Save state before change
            
            const rows = table.querySelectorAll('tr');
            rows.forEach((row, rowIdx) => {
                const cells = row.querySelectorAll('th, td');
                const isHeader = rowIdx === 0 && cells[0] && cells[0].tagName === 'TH';
                
                const newCell = document.createElement(isHeader ? 'th' : 'td');
                if (isHeader) {
                    newCell.style.cssText = 'background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);font-weight:700;color:white;text-transform:uppercase;letter-spacing:0.5px;font-size:9pt;border:none;padding:12px 16px;';
                } else {
                    newCell.style.cssText = 'border-bottom:1px solid #e5e7eb;padding:12px 16px;';
                }
                newCell.innerHTML = '&nbsp;';
                
                // Insert after the column at colIndex
                const refCell = cells[colIndex];
                if (refCell && refCell.nextSibling) {
                    row.insertBefore(newCell, refCell.nextSibling);
                } else {
                    row.appendChild(newCell);
                }
            });
            
            // Re-setup buttons
            setupTableButtons();
            hasUnsavedChanges = true;
        }
        
        // Image functions
        function addImg() {
            saveSelection();
            saveToHistory(); // Save before image insert
            const modal = new bootstrap.Modal(document.getElementById('insertImageModal'));
            modal.show();
        }
        
        function insertImageFromModal() {
            const fileInput = document.getElementById('imageFileInput');
            const urlInput = document.getElementById('imageUrlInput');
            
            restoreSelection();
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgHtml = `<img src="${e.target.result}" style="max-width:100%;height:auto;" />`;
                    document.execCommand('insertHTML', false, imgHtml);
                    
                    setTimeout(() => {
                        const imgs = doc.querySelectorAll('img');
                        imgs.forEach(img => {
                            if (!img.onclick) setupImg(img);
                        });
                    }, 100);
                    
                    fileInput.value = '';
                    urlInput.value = '';
                    bootstrap.Modal.getInstance(document.getElementById('insertImageModal')).hide();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else if (urlInput.value) {
                const imgHtml = `<img src="${urlInput.value}" style="max-width:100%;height:auto;" />`;
                document.execCommand('insertHTML', false, imgHtml);
                
                setTimeout(() => {
                    const imgs = doc.querySelectorAll('img');
                    imgs.forEach(img => {
                        if (!img.onclick) setupImg(img);
                    });
                }, 100);
                
                fileInput.value = '';
                urlInput.value = '';
                bootstrap.Modal.getInstance(document.getElementById('insertImageModal')).hide();
            } else {
                alert('Please select a file or enter a URL');
            }
        }
        
        // Link functions
        function addLink() {
            const modal = new bootstrap.Modal(document.getElementById('insertLinkModal'));
            const selection = window.getSelection();
            if (selection.toString()) {
                document.getElementById('linkTextInput').value = selection.toString();
            }
            modal.show();
        }
        
        function insertLinkFromModal() {
            const text = document.getElementById('linkTextInput').value;
            const url = document.getElementById('linkUrlInput').value;
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            if (text) {
                const selection = window.getSelection();
                if (!selection.toString()) {
                    cmd('insertHTML', text);
                    const range = document.createRange();
                    range.selectNodeContents(doc);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            
            cmd('createLink', url);
            
            document.getElementById('linkTextInput').value = '';
            document.getElementById('linkUrlInput').value = '';
            bootstrap.Modal.getInstance(document.getElementById('insertLinkModal')).hide();
        }
        
        function replaceImage() {
            if (!selectedImg) return;
            const modal = new bootstrap.Modal(document.getElementById('insertImageModal'));
            modal.show();
            
            const originalInsert = window.insertImageFromModal;
            window.insertImageFromModal = function() {
                const fileInput = document.getElementById('imageFileInput');
                const urlInput = document.getElementById('imageUrlInput');
                
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedImg.src = e.target.result;
                        fileInput.value = '';
                        urlInput.value = '';
                        bootstrap.Modal.getInstance(document.getElementById('insertImageModal')).hide();
                        window.insertImageFromModal = originalInsert;
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else if (urlInput.value) {
                    selectedImg.src = urlInput.value;
                    selectedImg.onerror = function() {
                        alert('Failed to load image from URL.');
                    };
                    fileInput.value = '';
                    urlInput.value = '';
                    bootstrap.Modal.getInstance(document.getElementById('insertImageModal')).hide();
                    window.insertImageFromModal = originalInsert;
                } else {
                    alert('Please select a file or enter a URL');
                }
            };
        }
        
        // Image manipulation
        function setupImg(img) {
            img.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                selectImg(this);
            };
        }
        
        function selectImg(img) {
            doc.querySelectorAll('img').forEach(i => {
                i.classList.remove('selected');
                removeResizeHandles();
            });
            
            selectedImg = img;
            img.classList.add('selected');
            
            const controls = document.getElementById('imgControls');
            controls.classList.add('show');
            
            const rect = img.getBoundingClientRect();
            controls.style.left = (rect.right + 10) + 'px';
            controls.style.top = rect.top + 'px';
            
            document.getElementById('imgWidth').value = Math.round(img.offsetWidth);
            document.getElementById('imgHeight').value = Math.round(img.offsetHeight);
            
            addResizeHandles(img);
        }
        
        function addResizeHandles(img) {
            const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
            handles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = 'resize-handle ' + pos;
                handle.dataset.position = pos;
                handle.onmousedown = startResize;
                img.parentElement.style.position = 'relative';
                img.parentElement.insertBefore(handle, img.nextSibling);
            });
        }
        
        function removeResizeHandles() {
            document.querySelectorAll('.resize-handle').forEach(h => h.remove());
        }
        
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!selectedImg) return;
            
            resizing = true;
            resizeHandle = e.target.dataset.position;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = selectedImg.offsetWidth;
            startHeight = selectedImg.offsetHeight;
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        
        function doResize(e) {
            if (!resizing || !selectedImg) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newWidth = startWidth;
            let newHeight = startHeight;
            
            if (resizeHandle.includes('e')) newWidth = startWidth + deltaX;
            if (resizeHandle.includes('w')) newWidth = startWidth - deltaX;
            if (resizeHandle.includes('s')) newHeight = startHeight + deltaY;
            if (resizeHandle.includes('n')) newHeight = startHeight - deltaY;
            
            if (resizeHandle.length === 2) {
                const aspectRatio = startWidth / startHeight;
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    newHeight = newWidth / aspectRatio;
                } else {
                    newWidth = newHeight * aspectRatio;
                }
            }
            
            newWidth = Math.max(50, newWidth);
            newHeight = Math.max(50, newHeight);
            
            selectedImg.style.width = newWidth + 'px';
            selectedImg.style.height = newHeight + 'px';
            
            document.getElementById('imgWidth').value = Math.round(newWidth);
            document.getElementById('imgHeight').value = Math.round(newHeight);
            
            removeResizeHandles();
            addResizeHandles(selectedImg);
        }
        
        function stopResize() {
            resizing = false;
            resizeHandle = null;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }
        
        document.getElementById('imgWidth').oninput = function() {
            if (selectedImg) {
                selectedImg.style.width = this.value + 'px';
                selectedImg.removeAttribute('width');
                selectedImg.removeAttribute('height');
                setTimeout(() => {
                    document.getElementById('imgHeight').value = selectedImg.offsetHeight;
                }, 50);
            }
        };
        
        document.getElementById('imgHeight').oninput = function() {
            if (selectedImg) {
                selectedImg.style.height = this.value + 'px';
                selectedImg.style.width = 'auto';
                selectedImg.removeAttribute('width');
                selectedImg.removeAttribute('height');
                setTimeout(() => {
                    document.getElementById('imgWidth').value = selectedImg.offsetWidth;
                }, 50);
            }
        };
        
        function rotateImg(deg) {
            if (!selectedImg) return;
            const current = selectedImg.style.transform || 'rotate(0deg)';
            const match = current.match(/rotate\((-?\d+)deg\)/);
            const currentDeg = match ? parseInt(match[1]) : 0;
            selectedImg.style.transform = `rotate(${currentDeg + deg}deg)`;
        }
        
        function alignImg(alignment) {
            if (!selectedImg) return;
            saveToHistory();
            
            // Wrap image in a div if not already wrapped
            let wrapper = selectedImg.parentElement;
            if (!wrapper || wrapper.id === 'doc') {
                wrapper = document.createElement('div');
                selectedImg.parentNode.insertBefore(wrapper, selectedImg);
                wrapper.appendChild(selectedImg);
            }
            
            // Apply alignment
            switch(alignment) {
                case 'left':
                    wrapper.style.textAlign = 'left';
                    selectedImg.style.display = 'inline-block';
                    selectedImg.style.marginLeft = '0';
                    selectedImg.style.marginRight = 'auto';
                    break;
                case 'center':
                    wrapper.style.textAlign = 'center';
                    selectedImg.style.display = 'block';
                    selectedImg.style.marginLeft = 'auto';
                    selectedImg.style.marginRight = 'auto';
                    break;
                case 'right':
                    wrapper.style.textAlign = 'right';
                    selectedImg.style.display = 'inline-block';
                    selectedImg.style.marginLeft = 'auto';
                    selectedImg.style.marginRight = '0';
                    break;
            }
            hasUnsavedChanges = true;
        }
        
        function deleteImg() {
            if (selectedImg && confirm('Delete this image?')) {
                saveToHistory(); // Save before delete
                selectedImg.remove();
                selectedImg = null;
                document.getElementById('imgControls').classList.remove('show');
            }
        }
        
        doc.onclick = function(e) {
            if (e.target.tagName !== 'IMG' && !e.target.classList.contains('resize-handle')) {
                doc.querySelectorAll('img').forEach(i => i.classList.remove('selected'));
                removeResizeHandles();
                document.getElementById('imgControls').classList.remove('show');
                selectedImg = null;
            }
        };
        
        // Zoom
        function zoom(d) {
            zoomVal = Math.max(50, Math.min(200, zoomVal + d));
            document.querySelector('.page').style.transform = `scale(${zoomVal/100})`;
            document.querySelector('.page').style.transformOrigin = 'top center';
            document.getElementById('zoomTxt').textContent = zoomVal + '%';
        }
        
        // Keyboard shortcuts - using keyCode for better browser compatibility
        document.addEventListener('keydown', function(e) {
            const isCtrl = e.ctrlKey || e.metaKey;
            const key = e.key.toLowerCase();
            
            if (isCtrl) {
                switch(key) {
                    case 'z':
                        e.preventDefault();
                        e.stopPropagation();
                        if (e.shiftKey) {
                            customRedo();
                        } else {
                            customUndo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        e.stopPropagation();
                        customRedo();
                        break;
                    case 'b':
                        e.preventDefault();
                        e.stopPropagation();
                        cmd('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        e.stopPropagation();
                        cmd('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        e.stopPropagation();
                        cmd('underline');
                        break;
                    case 'a':
                        e.preventDefault();
                        e.stopPropagation();
                        cmd('selectAll');
                        break;
                    case 'f':
                        e.preventDefault();
                        e.stopPropagation();
                        toggleFindReplace();
                        break;
                    case 'h':
                        e.preventDefault();
                        e.stopPropagation();
                        toggleFindReplace();
                        setTimeout(() => document.getElementById('replaceInput').focus(), 100);
                        break;
                    case 's':
                        e.preventDefault();
                        e.stopPropagation();
                        document.getElementById('saveBtn').click();
                        hasUnsavedChanges = false;
                        break;
                }
                
                if (e.shiftKey && key === 'v') {
                    e.preventDefault();
                    navigator.clipboard.readText().then(text => {
                        document.execCommand('insertText', false, text);
                    });
                }
            }
            
            if (e.key === 'Tab' && !selectedImg) {
                e.preventDefault();
                if (e.shiftKey) {
                    cmd('outdent');
                } else {
                    cmd('indent');
                }
            }
            
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                document.execCommand('insertHTML', false, '<br>');
            }
            
            if (e.key === 'Delete' && selectedImg) {
                e.preventDefault();
                deleteImg();
            }
            
            if (e.key === 'Escape') {
                document.getElementById('findReplacePanel').classList.remove('show');
                document.getElementById('imgControls').classList.remove('show');
            }
        });
        
        // Save/Export
        document.getElementById('saveBtn').onclick = function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            
            // Clear find highlights before export
            clearHighlights();
            
            // Clone the content and remove table edit buttons
            const docClone = doc.cloneNode(true);
            docClone.querySelectorAll('.table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn').forEach(btn => btn.remove());
            
            // Reset padding added for edit buttons
            docClone.style.padding = '0';
            
            const styles = Array.from(document.styleSheets).map(s => {
                try { return Array.from(s.cssRules || []).map(r => r.cssText).join('\n'); }
                catch(e) { return ''; }
            }).join('\n');
            
            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Print Preview</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @page { size: A4; margin: 0; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html { 
            height: 100%;
            overflow-y: scroll;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #e5e7eb;
            min-height: 100%;
            padding-bottom: 60px;
        }
        
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #0f172a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            z-index: 1000;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toolbar-icon {
            width: 32px;
            height: 32px;
            background: #2563eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toolbar-icon svg {
            width: 18px;
            height: 18px;
            fill: white;
        }
        
        .toolbar-title {
            color: #f8fafc;
            font-size: 14px;
            font-weight: 600;
        }
        
        .toolbar-right {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }
        
        .btn-secondary {
            background: #334155;
            color: #f1f5f9;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .content {
            padding-top: 80px;
            display: flex;
            justify-content: center;
        }
        
        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.05);
        }
        
        .table-row-add-btn, .table-col-add-btn, .table-row-del-btn, .table-col-del-btn { 
            display: none !important; 
        }
        
        @media print {
            body { 
                background: white; 
                padding: 0;
            }
            .toolbar { display: none !important; }
            .content { padding: 0; }
            .page { 
                box-shadow: none;
                width: 100%;
                margin: 0;
            }
        }
        ${styles}
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-left">
            
            <span class="toolbar-title" style="color: #000000ff;">Print Preview</span>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" onclick="window.close()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                Close
            </button>
            <button class="btn btn-primary" onclick="window.print()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                Print
            </button>
        </div>
    </div>
    <div class="content">
        <div class="page">${docClone.innerHTML}</div>
    </div>
</body>
</html>`;
            
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-file-pdf"></i> Export PDF';
        };
        
        function closeEditor() {
            if (hasUnsavedChanges) {
                if (confirm('Close editor? You have unsaved changes.')) {
                    hasUnsavedChanges = false;
                    window.location.href = '/';
                }
            } else {
                window.location.href = '/';
            }
        }
        
        // Settings & Theme
        function loadSettings() {
            const theme = localStorage.getItem('editorTheme') || 'light';
            changeTheme(theme);
        }
        
        function openSettings() {
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        }
        
        function changeTheme(theme) {
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (localStorage.getItem('editorTheme') === 'auto') {
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            localStorage.setItem('editorTheme', theme);
        }
        
        loadSettings();
    </script>
</body>
</html>
